<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.111.3"><meta name=description content><link rel=icon href=/images/favicon.png type=image/png><title>Advanced network scenarios :: Ventus Docs</title><link href=/css/nucleus.css?1680863264 rel=stylesheet><link href=/css/fontawesome-all.min.css?1680863264 rel=stylesheet><link href=/css/hybrid.css?1680863264 rel=stylesheet><link href=/css/featherlight.min.css?1680863264 rel=stylesheet><link href=/css/perfect-scrollbar.min.css?1680863264 rel=stylesheet><link href=/css/auto-complete.css?1680863264 rel=stylesheet><link href=/css/atom-one-dark-reasonable.css?1680863264 rel=stylesheet><link href=/css/theme.css?1680863264 rel=stylesheet><link href=/css/tabs.css?1680863264 rel=stylesheet><link href=/css/hugo-theme.css?1680863264 rel=stylesheet><link href=/css/theme-blue.css?1680863264 rel=stylesheet><script src=/js/jquery-3.3.1.min.js?1680863264></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style></head><body data-url=/tutorials-advanced/advanced-network-scenarios/><nav id=sidebar><div id=header-wrapper><div id=header></div><div class=searchbox><label for=search-by><i class="fas fa-search"></i></label>
<input data-search-input id=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span></div><script type=text/javascript src=/js/lunr.min.js?1680863264></script>
<script type=text/javascript src=/js/auto-complete.js?1680863264></script>
<script type=text/javascript>var baseurl="https://docs.ventuscloud.eu/"</script><script type=text/javascript src=/js/search.js?1680863264></script></div><section id=homelinks><ul><li><a class=padding href=/><i class='fas fa-home'></i> Home</a></li></ul></section><div class=highlightable><ul class=topics><li data-nav-id=/getting-started/ title="Getting Started" class=dd-item><a href=/getting-started/><b>1. </b>Getting Started</a><ul><li data-nav-id=/getting-started/account/ title=Account class=dd-item><a href=/getting-started/account/>Account</a></li><li data-nav-id=/getting-started/organizations/ title=Organizations class=dd-item><a href=/getting-started/organizations/>Organizations</a></li><li data-nav-id=/getting-started/projects/ title=Projects class=dd-item><a href=/getting-started/projects/>Projects</a></li></ul></li><li data-nav-id=/identity-management/ title="Identity Management" class=dd-item><a href=/identity-management/><b>2. </b>Identity Management</a><ul><li data-nav-id=/identity-management/administrators/ title=Administrators class=dd-item><a href=/identity-management/administrators/>Administrators</a></li><li data-nav-id=/identity-management/groups/ title=Groups class=dd-item><a href=/identity-management/groups/>Groups</a></li></ul></li><li data-nav-id=/products/ title=Products class=dd-item><a href=/products/><b>3. </b>Products</a><ul><li data-nav-id=/products/compute/ title=COMPUTE class=dd-item><a href=/products/compute/><b></b>COMPUTE</a><ul><li data-nav-id=/products/compute/virtual-machines/ title="Virtual Machines" class=dd-item><a href=/products/compute/virtual-machines/>Virtual Machines</a></li><li data-nav-id=/products/compute/connect-linux-vm/ title="Access Linux VM" class=dd-item><a href=/products/compute/connect-linux-vm/>Access Linux VM</a></li><li data-nav-id=/products/compute/connect-windows-vm/ title="Access Windows VM" class=dd-item><a href=/products/compute/connect-windows-vm/>Access Windows VM</a></li></ul></li><li data-nav-id=/products/kubernetes/ title=KUBERNETES class=dd-item><a href=/products/kubernetes/><b></b>KUBERNETES</a><ul><li data-nav-id=/products/kubernetes/kubernetes-cluster/ title="K8S Cluster" class=dd-item><a href=/products/kubernetes/kubernetes-cluster/>K8S Cluster</a></li><li data-nav-id=/products/kubernetes/accessing-kuber/ title="Access K8S Cluster" class=dd-item><a href=/products/kubernetes/accessing-kuber/>Access K8S Cluster</a></li></ul></li><li data-nav-id=/products/security/ title=SECURITY class=dd-item><a href=/products/security/><b></b>SECURITY</a><ul><li data-nav-id=/products/security/firewalls/ title=Firewalls class=dd-item><a href=/products/security/firewalls/>Firewalls</a></li><li data-nav-id=/products/security/firewall-rules/ title="Firewall Rules" class=dd-item><a href=/products/security/firewall-rules/>Firewall Rules</a></li><li data-nav-id=/products/security/manage-firewalls/ title="VM's Firewalls" class=dd-item><a href=/products/security/manage-firewalls/>VM's Firewalls</a></li><li data-nav-id=/products/security/ssh-keys/ title="SSH Keys" class=dd-item><a href=/products/security/ssh-keys/>SSH Keys</a></li><li data-nav-id=/products/security/cli-users/ title="CLI Users" class=dd-item><a href=/products/security/cli-users/>CLI Users</a></li></ul></li><li data-nav-id=/products/storage/ title=STORAGE class=dd-item><a href=/products/storage/><b></b>STORAGE</a><ul><li data-nav-id=/products/storage/object-storage/ title="Object Storage" class=dd-item><a href=/products/storage/object-storage/>Object Storage</a></li><li data-nav-id=/products/storage/object-storage-credentials/ title="Object Storage Credentials" class=dd-item><a href=/products/storage/object-storage-credentials/>Object Storage Credentials</a></li><li data-nav-id=/products/storage/volumes/ title=Volumes class=dd-item><a href=/products/storage/volumes/>Volumes</a></li><li data-nav-id=/products/storage/manage-volumes/ title="VM's Volumes" class=dd-item><a href=/products/storage/manage-volumes/>VM's Volumes</a></li><li data-nav-id=/products/storage/snapshots/ title=Snapshots class=dd-item><a href=/products/storage/snapshots/>Snapshots</a></li><li data-nav-id=/products/storage/manage-snapshots/ title="VM's Snapshots" class=dd-item><a href=/products/storage/manage-snapshots/>VM's Snapshots</a></li></ul></li><li data-nav-id=/products/images/ title=IMAGES class=dd-item><a href=/products/images/><b></b>IMAGES</a><ul><li data-nav-id=/products/images/custom-images/ title=Images class=dd-item><a href=/products/images/custom-images/>Images</a></li><li data-nav-id=/products/images/image-from-snapshot/ title="Create Image from Snapshot" class=dd-item><a href=/products/images/image-from-snapshot/>Create Image from Snapshot</a></li><li data-nav-id=/products/images/share-images/ title="Share Images between Projects" class=dd-item><a href=/products/images/share-images/>Share Images between Projects</a></li><li data-nav-id=/products/images/transfer-images/ title="Transfer Images between Regions" class=dd-item><a href=/products/images/transfer-images/>Transfer Images between Regions</a></li></ul></li><li data-nav-id=/products/networking/ title=NETWORKING class=dd-item><a href=/products/networking/><b></b>NETWORKING</a><ul><li data-nav-id=/products/networking/networks/ title=Networks class=dd-item><a href=/products/networking/networks/>Networks</a></li><li data-nav-id=/products/networking/floating-ips/ title="Floating IPs" class=dd-item><a href=/products/networking/floating-ips/>Floating IPs</a></li><li data-nav-id=/products/networking/routers/ title=Routers class=dd-item><a href=/products/networking/routers/>Routers</a></li><li data-nav-id=/products/networking/subnets/ title=Subnets class=dd-item><a href=/products/networking/subnets/>Subnets</a></li><li data-nav-id=/products/networking/manage-networks/ title="VM's Networks and Interfaces" class=dd-item><a href=/products/networking/manage-networks/>VM's Networks and Interfaces</a></li></ul></li></ul></li><li data-nav-id=/tutorials-advanced/ title=Advanced class="dd-item
parent"><a href=/tutorials-advanced/><b>4. </b>Advanced</a><ul><li data-nav-id=/tutorials-advanced/installation-openstack-cli/ title="Installation OpenStack CLI" class=dd-item><a href=/tutorials-advanced/installation-openstack-cli/>Installation OpenStack CLI</a></li><li data-nav-id=/tutorials-advanced/working-with-openstack-api/ title="Working with OpenStack API" class=dd-item><a href=/tutorials-advanced/working-with-openstack-api/>Working with OpenStack API</a></li><li data-nav-id=/tutorials-advanced/org-management-over-api/ title="Organization's management over API" class=dd-item><a href=/tutorials-advanced/org-management-over-api/>Organization's management over API</a></li><li data-nav-id=/tutorials-advanced/advanced-network-scenarios/ title="Advanced network scenarios" class="dd-item active"><a href=/tutorials-advanced/advanced-network-scenarios/>Advanced network scenarios</a></li><li data-nav-id=/tutorials-advanced/site-to-site-ipsec-vpn/ title="The Site to Site IPSec VPN" class=dd-item><a href=/tutorials-advanced/site-to-site-ipsec-vpn/>The Site to Site IPSec VPN</a></li></ul></li><li data-nav-id=/terms-and-conditions/ title="Terms and Conditions" class=dd-item><a href=/terms-and-conditions/><b>5. </b>Terms and Conditions</a><ul><li data-nav-id=/terms-and-conditions/privacy-policy/ title="Privacy Policy" class=dd-item><a href=/terms-and-conditions/privacy-policy/>Privacy Policy</a></li><li data-nav-id=/terms-and-conditions/terms-and-conditions/ title="Terms and Conditions" class=dd-item><a href=/terms-and-conditions/terms-and-conditions/>Terms and Conditions</a></li><li data-nav-id=/terms-and-conditions/devops-as-a-service/ title="Devops as a Service" class=dd-item><a href=/terms-and-conditions/devops-as-a-service/>Devops as a Service</a></li></ul></li></ul><section id=footer><p>Built with <a href=https://github.com/matcornic/hugo-theme-learn><i class="fas fa-heart"></i></a> from <a href=https://getgrav.org>Grav</a> and <a href=https://gohugo.io/>Hugo</a></p></section></div></nav><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i></a></span>
<span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links><a href=/>Home Page</a> > <a href=/tutorials-advanced/>Advanced</a> > Advanced network scenarios</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><a href=#prerequisites>Prerequisites</a></li><li><a href=#port-migration>Port Migration</a></li><li><a href=#floating-ip>Floating IP</a></li><li><a href=#load-balancer>Load Balancer</a></li></ul></nav></div></div></div></div><div id=head-tags></div><div id=body-inner><h1>Advanced network scenarios</h1><hr><p>On this page we will discuss scenarios, that can help you to build software upgrade friendly and fault-tolerant cloud infrastructure.</p><blockquote><p>Most of the topics described below considered advanced. Basic Linux and Networking skills are required. Please contact support if you need guidance and best practices for your specific use case.</p><p>Most of the features described below are in beta state, thus not available at the Console portal, and can be configured through CLI and IaC tools like Terraform and Ansible.</p></blockquote><h1 id=table-of-contents>Table of contents</h1><ul><li><a href=#table-of-contents>Table of contents</a><ul><li><a href=#prerequisites>Prerequisites</a></li><li><a href=#port-migration>Port Migration</a></li><li><a href=#floating-ip>Floating IP</a></li><li><a href=#load-balancer>Load Balancer</a></li></ul></li></ul><h2 id=prerequisites>Prerequisites</h2><ol><li>CLI User created. To find more detailed instructions see the article - <a href=https://docs.ventuscloud.eu/products/security/cli-users/>CLI Users</a>.</li><li>Openstack Client Configured. To find more detailed instructions see the article - <a href=https://docs.ventuscloud.eu/tutorials-advanced/installation-openstack-cli/>Installation OpenStack CLI</a>.</li></ol><h2 id=port-migration>Port Migration</h2><p>Port migration can be used in drop-in replacement of instances in case of major software upgrades or recovery scenarios, especially when you need to preserve initial networking settings and you didn&rsquo;t plan for such actions in advance by leveraging Floating IPs or Load Balancers.</p><p><strong>Scenarios:</strong></p><ul><li>Install and configure new instance nearby to old one, verify internally that it works as expected and then switch production traffic to it with preserving ability to rollback to previous version (instance).</li><li>In case of major failures - restore instance from backup and leverage previously used IP.</li></ul><p><img src="../../assets/images/tutorials/12.png?classes=border,shadow" alt></p><p><strong>Configuration</strong><br>Make sure that CLI user has SSH key:<br><code>openstack key list</code></p><p>Create SSH key if needed:<br><code>openstack key create --public-key .ssh/id_rsa.pub ssh_key_name</code></p><p>Create ports for your planned servers:<br><code>openstack port create --network public server-1-port</code><br><code>openstack port create --network public server-2-port</code></p><p>Choose images and flavors for servers:<br><code>openstack image list</code><br><code>openstack flavor list</code></p><p>Create servers with corresponding ports:</p><pre tabindex=0><code>openstack server create \
--image &#39;centos-8.2-2004&#39; \
--boot-from-volume 100 \
--flavor VC-4 \
--security-group default \
--port server-1-port \
--key-name ssh_key_name \
server1

openstack server create \
--image &#39;centos-8.2-2004&#39; \
--boot-from-volume 100 \
--flavor VC-4 \
--security-group default \
--port server-2-port \
--key-name ssh_key_name \
server2
</code></pre><p>Verify created servers:<br><code>openstack server list</code><br><code>openstack port list</code></p><p><strong>Optionally:</strong><br>Install Nginx web server on server1 and Apache on server2 and configure firewall rule to allow TCP port 80 from your workstation:</p><ul><li><strong>Centos:</strong><ul><li><em>Server1:</em><br><code>yum install nginx</code><br><code>systemctl enable nginx</code><br><code>systemctl start nginx</code></li><li><em>Server2:</em><br><code>yum install httpd</code><br><code>systemctl enable httpd</code><br><code>systemctl start httpd</code></li></ul></li><li><strong>Ubuntu:</strong><ul><li><em>Server1:</em><br><code>apt update</code><br><code>apt install nginx</code><br><code>systemctl enable nginx</code><br><code>systemctl start nginx</code></li><li><em>Server2:</em><br><code>apt install apache2</code><br><code>systemctl enable apache2</code><br><code>systemctl start apache2</code><br>Verify that IP addres of server-1-port is served by nginx webserver and IP addres of server-2-port served by Apache:
<code>curl &lt;IP addres of server-1-port></code><br><code>curl &lt;IP addres of server-2-port></code></li></ul></li></ul><p><strong>Perform failover.</strong></p><ul><li>Detaching ports from servers:</li></ul><pre tabindex=0><code>openstack server remove port &lt;server&gt; &lt;port&gt;
openstack server remove port server1 server-1-port
openstack server remove port server2 server-2-port
</code></pre><ul><li>Attaching port of server1 to server2 and vice versa:</li></ul><pre tabindex=0><code>openstack server add port &lt;server&gt; &lt;port&gt;
openstack server add port server1 server-2-port
openstack server add port server2 server-1-port
</code></pre><ul><li>Reboot servers if needed:</li></ul><pre tabindex=0><code>openstack server reboot server1
openstack server reboot server2
</code></pre><ul><li>Verify that ports were switched:</li></ul><pre tabindex=0><code>openstack server list
openstack port list
</code></pre><p><strong>Optionally:</strong><br>Verify that IP address of server-1-port is now served by Apache webserver and IP address of server-2-port is now served by Nginx web servers. It will mean that we successfully switched ports of our servers.<br><code>curl &lt;IP addres of server-1-port></code><br><code>curl &lt;IP addres of server-2-port></code></p><p><strong>Pro Tips:</strong></p><ul><li><p><em>Use &ldquo;&ndash;fixed-ip&rdquo; argument during port creation for better control of IP allocation in private networks e.g.:</em><br><code>openstack port create --network &lt;network_name> --fixed-ip subnet=&lt;subnet_name>,ip-address=&lt;ip_address> &lt;port_name></code><br>e.g.:<br><code>openstack port create --network network1 --fixed-ip subnet=subnet1,ip-address=10.0.0.10 server-1-port</code></p></li><li><p><em>You can assign multiple ports to one instance e.g.:</em><br><code>openstack server add port server1 server-1-port</code><br><code>openstack server add port server1 server-2-port</code></p></li><li><p><em>Remove IP address from port:</em><br><code>openstack port set --no-fixed-ip &lt;port_id></code><br>e.g.:<br><code>openstack port set --no-fixed-ip 68c763c4-d523-4a47-baf9-XXXXXXXXXXXX</code></p></li><li><p><em>Assign Desired IP to port:</em><br><code>openstack port set --fixed-ip subnet=&lt;subnet_name>,ip-address=&lt;ip_address> &lt;port_id></code><br>e.g.:<br><code>openstack port set --fixed-ip subnet=subnet1,ip-address=10.0.0.10 68c763c4-a293-68f9-anr6-XXXXXXXXXXXX</code></p></li><li><p><em>Assign multiple IP addresses to one port:</em><br><code>openstack port set --fixed-ip subnet=subnet1,ip-address=10.0.0.11 68c763c4-a293-68f9-anr6-XXXXXXXXXXXX</code><br><code>openstack port set --fixed-ip subnet=subnet1,ip-address=10.0.0.12 68c763c4-a293-68f9-anr6-XXXXXXXXXXXX</code><br><code>openstack port set --fixed-ip subnet=subnet1,ip-address=10.0.0.13 68c763c4-a293-68f9-anr6-XXXXXXXXXXXX</code></p></li><li><p><em>You can use a custom MAC address for port. Contact support if you need it.</em></p></li></ul><div class="notices warning"><p>This scenario is very complex and <strong>heavily affected by OS settings inside instance.</strong><br>Binding to MAC addresses in your network configuration tool (Netplan, systemd-networkd, others) can cause networking failure.<br>Routing table affected by new/changed network interfaces can cause networking failure.<br>Firewalls with strict rules can cause networking failure.<br>Please. test this scenario in advance in Non-production environment.</p></div><p><strong>Conclusion</strong><br>As you can see, the port modification functionality is very powerful and let you similar functionality with what you can do with physical devices and even beyond that. But as a drawback, it leads to complexity and difficulties in configurations on many levels. We recommend avoiding working directly with ports and consider the usage of more advanced features like Floating IPs and Load Balancers except for cases when you really need it.</p><h2 id=floating-ip>Floating IP</h2><p>Floating IP is an IP address allocated from Public network range by request and associated with specific project. You can assign Floating IP to any of your instances provisioned in private networks. This provides great flexibility in management of your network resources.</p><p><em>Some of the key advantages provided by Floating IPs:</em></p><ul><li>Once Floating IP created - it will stay in your project until you explicitly delete it. Regardless if you delete resources to which it attached. It guarantees that you will have your stable static IP for as long as it needed for your infrastructure.</li><li>You can create multiple Floating IPs per project.</li><li>You can almost immediately transfer Floating IP from one instance to another without any interruptions to service.</li><li>Instance itself doesn&rsquo;t know about Floating IP existence. You don&rsquo;t have additional network interface on OS level. You don&rsquo;t need to care about routing with multiple interfaces.</li></ul><p>You need to know that:</p><ul><li>Floating IP can be assigned only to instance provisioned in private network with configured router with external gateway.</li><li>Only one Floating IP can be assigned to instance at one time.</li><li>You canâ€™t have Floating IP created from range of your private network.</li></ul><p><img src="../../assets/images/tutorials/13.png?classes=border,shadow" alt></p><p><strong>Configuration</strong><br>Create private network:<br><code>openstack network create private</code></p><p>Create and configure subnet:</p><pre tabindex=0><code>openstack subnet create \
--gateway 10.0.0.1 \
--dns-nameserver 8.8.8.8 \
--subnet-range 10.0.0.0/24 \
--allocation-pool start=10.0.0.10,end=10.0.0.200 \
--network private \
private_subnet
</code></pre><p>Create router to let instances in private network access to internet:<br><code>openstack router create private_gateway</code></p><p>Configure gateway for router:<br><code>openstack router set --external-gateway public private_gateway</code></p><p>Attach router to private subnet (enable routing):<br><code>openstack router add subnet private_gateway private_subnet</code></p><p>Create a couple of servers in private network:</p><pre tabindex=0><code>openstack server create \
--image &#39;centos-8.2-2004&#39; \
--boot-from-volume 100 \
--flavor VC-4 \
--security-group default \
--network private \
--key-name ssh_key_name \
server1

openstack server create \
--image &#39;centos-8.2-2004&#39; \
--boot-from-volume 100 \
--flavor VC-4 \
--security-group default \
--network private \
--key-name ssh_key_name \
server2
</code></pre><p>Make sure that servers created in private subnet range and you can&rsquo;t connect to it over internet:<br><code>openstack server list</code></p><p>Create floating IP:<br><code>openstack floating ip create public</code></p><p>Show list of floating IPs available:<br><code>openstack floating ip list</code></p><p>Assign Floating IP to server1:<br><code>#openstack server add floating ip server1 &lt;floating_ip_address></code><br><code>openstack server add floating ip server1 88.218.52.5</code></p><p>Verify that you can connect to server1 over internet using Floating IP address.
<em>Make sure that you allowed SSH access on Cloud Console Firewall</em> - to find more
detailed instructions see the article - <a href>Firewall Rules</a>:<br><code>#ssh centos@&lt;floating_ip_address></code><br><code>ssh centos@88.218.52.5</code></p><p>Reassign Floating IP to server2:<br><code>#openstack server add floating ip server2 &lt;floating_ip_address></code><br><code>openstack server add floating ip server2 88.218.52.5</code></p><p>Connect to the same Floating IP over SSH and make sure that you are now accessing server2 instead of server1 using the very same address:<br><code>#ssh centos@&lt;floating_ip_address></code><br><code>ssh centos@88.218.52.5</code></p><p>Delete server2 and verify that Floatin IP still exists in your project and can be reused:<br><code>openstack server delete server2</code><br><code>openstack floating ip list</code></p><p>Assign Floating IP to server1:<br><code>#openstack server add floating ip server1 &lt;floating_ip_address></code><br><code>openstack server add floating ip server1 88.218.52.5</code><br><code>openstack floating ip list</code></p><p>Unassign Floating IP from Any servers:<br><code>#openstack server remove floating ip server1 &lt;floating_ip_address></code><br><code>openstack server remove floating ip server1 88.218.52.5</code><br><code>openstack floating ip list</code></p><p><strong>Conclusion</strong><br>Floating IP is a great addition to your infrastructure. It&rsquo;s simple to use. It let you great flexibility in performing drop-in replacement of instances. It guarantees you the stability of the IP address - once you created it will be yours until explicit termination. It can highly increase your security by running all of your workload inside a private network still being able to access the environment using jump servers with adding Public IP only for a limited time (maintenance) and others.</p><h2 id=load-balancer>Load Balancer</h2><p>Load balancer is a feature designed to satisfy the needs of the most complex and modern distributed application architectures. It helps to increase the performance of your application by distributing requests over multiple instances based on the chosen algorithm as well as reduce possible interruption to service caused by failed instances by leveraging instance auto-eviction functionality based on health probes.</p><p><img src="../../assets/images/tutorials/14.png?classes=border,shadow" alt></p><p><strong>Configuration</strong><br>Create and configure network:</p><pre tabindex=0><code>openstack network create private

openstack subnet create \
--gateway 10.0.0.1 \
--dns-nameserver 8.8.8.8 \
--subnet-range 10.0.0.0/24 \
--allocation-pool start=10.0.0.10,end=10.0.0.200 \
--network private \
private_subnet

openstack router create private_gateway
openstack router set --external-gateway public private_gateway 
openstack router add subnet private_gateway private_subnet
</code></pre><p>Create a couple of servers in private network so we can test Load Balancer.</p><p>This time we will leverage User Data a.k.a. Cloud-Init feature for automatic preconfiguration of software inside newly created instance without need to login to it.</p><p>Prepare Cloud-Init config (adjust for your OS Distro accordingly):</p><pre tabindex=0><code>cat &lt;&lt; EOF &gt; ./server1.yaml
#cloud-config
runcmd: 
- yum install -y nginx 
- systemctl start nginx
EOF

cat &lt;&lt; EOF &gt; ./server2.yaml
#cloud-config
runcmd: 
- yum install -y httpd
- systemctl start httpd
EOF
</code></pre><p>Config of server1.yaml will install and start Nginx webserver on server1. Config of server2.yaml will install and enable Apache web server on server2:</p><pre tabindex=0><code>openstack server create \
--image &#39;centos-8.2-2004&#39; \
--boot-from-volume 100 \
--flavor VC-4 \
--security-group default \
--network private \
--key-name ssh_key_name \
--user-data ./server1.yaml \
server1

openstack server create \
--image &#39;centos-8.2-2004&#39; \
--boot-from-volume 100 \
--flavor VC-4 \
--security-group default \
--network private \
--key-name ssh_key_name \
--user-data ./server2.yaml \
server2
</code></pre><p>Now we have two servers with different web servers which listen on the same port. Both of them inside a private network therefore not reachable from the internet.</p><p><strong>Create Load Balancer</strong><br>Use the next command to create Load Balancer:<br><code>penstack loadbalancer create --name web --vip-subnet-id private_subnet</code></p><p>Create Load Balancer Listener:</p><pre tabindex=0><code>openstack loadbalancer listener create \
    --name web_listener \
    --protocol HTTP \
    --protocol-port 80 \
    web
</code></pre><p>Create Load Balancer Pool:</p><pre tabindex=0><code>openstack loadbalancer pool create \
    --name web_pool \
    --lb-algorithm ROUND_ROBIN \
    --listener web_listener \
    --protocol HTTP
</code></pre><p>Get servers ip:</p><pre tabindex=0><code>openstack server list
+--------------------------------------+---------+--------+--------------------+--------------------------+--------+
| ID | Name | Status | Networks | Image | Flavor |
+--------------------------------------+---------+--------+--------------------+--------------------------+--------+
| a1cb4833-c542-4cd4-b980-XXXXXXXXXXX  | server2 | ACTIVE | private=10.0.0.193 | N/A (booted from volume) | VC-4 |
| f4bb4bcd-6366-4bcd-83fa-XXXXXXXXXXX  | server1 | ACTIVE | private=10.0.0.19  | N/A (booted from volume) | VC-4 |
+--------------------------------------+---------+--------+--------------------+--------------------------+--------+
</code></pre><p>Add web servers/instances to Load Balancer&rsquo;s pool (use your IP addresses):</p><pre tabindex=0><code>openstack loadbalancer member create \
    --subnet-id private_subnet \
    --address 10.0.0.19 \
    --protocol-port 80 \
    web_pool

openstack loadbalancer member create \
    --subnet-id private_subnet \
    --address 10.0.0.193 \
    --protocol-port 80 \
    web_pool
</code></pre><p>Now we have preconfigured instances with installed and enabled web servers, created and configured Load Balancer, but everything is exposed only to internal network, let&rsquo;s fix that by adding Floating IP to our infrastructure:<br><code>openstack floating ip create public</code></p><p>Get IP address of Load Balancer listener:</p><pre tabindex=0><code>openstack loadbalancer list
+--------------------------------------+------+----------------------------------+-------------+---------------------+----------+
| id | name | project_id | vip_address | provisioning_status | provider |
+--------------------------------------+------+----------------------------------+-------------+---------------------+----------+
| ae2a65e5-293f-455d-8cb8-XXXXXXXXXXXX | web | 17a1fd0e5a87468da287XXXXXXXXXXXX | 10.0.0.48 | ACTIVE | amphora |
+--------------------------------------+------+----------------------------------+-------------+---------------------+----------+
</code></pre><p>Get Port ID of Load Balancer listener:</p><pre tabindex=0><code>openstack port list | grep 10.0.0.48
| 71292fef-7a94-43ac-bfe3-XXXXXXXXXXXX  | octavia-lb-ae2a65e5-293f-455d-8cb8-XXXXXXXXXXXX  | fa:16:3e:XX:XX:XX | ip_address=&#39;10.0.0.48&#39;, subnet_id=&#39;9efbdfb3-f86d-40f0-b07a-XXXXXXXXXXXX &#39; | DOWN |
</code></pre><p>Assign Previously created Floating IP to Load balancer&rsquo;s Listener port:</p><pre tabindex=0><code>openstack floating ip set --port 71292fef-7a94-43ac-bfe3-XXXXXXXXXXXX &lt;floating_ip_address&gt;
</code></pre><div class="notices tip"><p><strong>Pro Tips:</strong><br>Despite you can create Load Balancer directly in Public network, we highly recommend using of Floating IP&rsquo;s instead. This will dramatically increase your flexibility in upgrade/migration/disaster recovery scenarios but will keep all of the benefits of Load Balancer itself.</p></div><p>As result we have:</p><ul><li>Internal network with subnet;</li><li>Router which let instances access to internet;</li><li>Preconfigured instances with automatically installed web servers;</li><li>Fully configured Load Balancers with pool members of two web servers;</li><li>Floating IP attached to Load Balancer which exposes web services to internet over port 80.</li></ul><p>Test Load balancer Functionality:</p><pre tabindex=0><code>curl http://&lt;floating_ip_address&gt;
curl http://&lt;floating_ip_address&gt;
</code></pre><p>As we configured Load Balancer to work using Round Robin algorithm expected result - different responses on each HTTP request. This means that Load Balancer equally distributes traffic between all pool members.</p><div class="notices warning"><p>It&rsquo;s recommended to use curl instead of your Browser for testing purposes because the Browsers caching mechanism can mess results.</p></div><p>Now let&rsquo;s disable one of the web servers. You can shutdown instance or disable web server.</p><p>Expected result - you will always receive response only from one web server because Load Balancer will automatically detect that backend instance is down.</p><p>Restore your &ldquo;broken&rdquo; webserver and verify that now you receive results again from both web servers (Apache and Nginx).</p><p><strong>Change Load Balancer&rsquo;s algorithm.</strong><br>Some applications may benefit from accepting client requests to the same instance instead of distribution across all instances:<br><code>openstack loadbalancer pool set --lb-algorithm SOURCE_IP web_pool</code></p><p>Verify that Load Balancer&rsquo;s behavior changed:</p><pre tabindex=0><code>curl http://&lt;floating_ip_address&gt;
curl http://&lt;floating_ip_address&gt;
curl http://&lt;floating_ip_address&gt;
</code></pre><p>You should always receive results only from the same server.</p><p>Supported LB Algorithms:</p><ul><li>SOURCE_IP;</li><li>ROUND_ROBIN;</li><li>LEAST_CONNECTIONS;</li><li>SOURCE_IP_PORT;</li></ul><p>In addition, Load Balancers has a much more broad functionality than it was described above. It supports multiple pools, multiple listeners, SSL offloading, advanced monitors, and other what will be described in Load Balancers dedicated documentation.</p><p><strong>Conclusion</strong><br>Load Balancer is a powerful and advanced feature that can enhance multiple aspects of your application starting but not limiting with traffic distribution, fault detection, smooth adding, and removing instances from pools/farms/clusters. In conjunction with private networks, routers, and Floating IP it can become a great entry point for your application.</p><footer class=footline></footer></div></div><div id=navigation><a class="nav nav-prev" href=/tutorials-advanced/org-management-over-api/ title="Organization's management over API"><i class="fa fa-chevron-left"></i></a>
<a class="nav nav-next" href=/tutorials-advanced/site-to-site-ipsec-vpn/ title="The Site to Site IPSec VPN" style=margin-right:0><i class="fa fa-chevron-right"></i></a></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/js/clipboard.min.js?1680863264></script>
<script src=/js/perfect-scrollbar.min.js?1680863264></script>
<script src=/js/perfect-scrollbar.jquery.min.js?1680863264></script>
<script src=/js/jquery.sticky.js?1680863264></script>
<script src=/js/featherlight.min.js?1680863264></script>
<script src=/js/highlight.pack.js?1680863264></script>
<script>hljs.initHighlightingOnLoad()</script><script src=/js/modernizr.custom-3.6.0.js?1680863264></script>
<script src=/js/learn.js?1680863264></script>
<script src=/js/hugo-learn.js?1680863264></script>
<script src=/mermaid/mermaid.js?1680863264></script>
<script>mermaid.initialize({startOnLoad:!0})</script></body></html>